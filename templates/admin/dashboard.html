{% extends "admin/base.html" %}

{% block page_title %}Дашборд{% endblock %}

{% block content %}
    <div class="stats-grid">
        <div class="stat-card">
            <h3>Всего пользователей</h3>
            <div class="value">{{ total_users }}</div>
            <div class="trend">
                <i class="fas fa-user-plus"></i>
                <span>Зарегистрировано</span>
            </div>
        </div>
        
        <div class="stat-card">
            <h3>Всего книг</h3>
            <div class="value">{{ total_books }}</div>
            <div class="trend">
                <i class="fas fa-book"></i>
                <span>В каталоге</span>
            </div>
        </div>
        
        <div class="stat-card">
            <h3>Активные выдачи</h3>
            <div class="value">{{ active_loans }}</div>
            <div class="trend">
                <i class="fas fa-book-open"></i>
                <span>На руках у читателей</span>
            </div>
        </div>
        
        <div class="stat-card overdue">
            <h3>Просрочено</h3>
            <div class="value">{{ overdue_loans }}</div>
            <div class="trend">
                <i class="fas fa-exclamation-triangle"></i>
                <span>Требуют внимания</span>
            </div>
        </div>
        
        <div class="stat-card reservations">
            <h3>Ожидают выдачи</h3>
            <div class="value">{{ pending_reservations }}</div>
            <div class="trend">
                <i class="fas fa-bookmark"></i>
                <span>Резервации</span>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h2><i class="fas fa-history"></i> Последние выдачи книг</h2>
            <a href="{{ url_for('admin_loans') }}" class="btn btn-outline">Все выдачи</a>
        </div>
        
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Читатель</th>
                        <th>Книга</th>
                        <th>Дата выдачи</th>
                        <th>Вернуть до</th>
                        <th>Статус</th>
                    </tr>
                </thead>
                <tbody>
                    {% for loan in recent_loans %}
                    <tr>
                        <td>{{ loan.reader.full_name }}</td>
                        <td>{{ loan.book.title }}</td>
                        <td>{{ loan.loan_date.strftime('%d.%m.%Y') }}</td>
                        <td>{{ loan.due_date.strftime('%d.%m.%Y') }}</td>
                        <td>
                            {% if loan.status == 'active' %}
                                <span class="status-badge status-active">Активна</span>
                            {% elif loan.status == 'overdue' %}
                                <span class="status-badge status-overdue">Просрочена</span>
                            {% elif loan.status == 'returned' %}
                                <span class="status-badge status-returned">Возвращена</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h2><i class="fas fa-bookmark"></i> Последние резервации</h2>
            <a href="{{ url_for('admin_reservations') }}" class="btn btn-outline">Все резервации</a>
        </div>

        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Читатель</th>
                        <th>Книга</th>
                        <th>Дата резервации</th>
                        <th>Статус</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for reservation in recent_reservations %}
                    <tr>
                        <td>{{ reservation.reader.full_name }}</td>
                        <td>{{ reservation.book.title }}</td>
                        <td>{{ reservation.reservation_date.strftime('%d.%m.%Y') }}</td>
                        <td>
                            {% if reservation.status == 'pending' %}
                                <span class="status-badge status-pending">Ожидает</span>
                            {% elif reservation.status == 'fulfilled' %}
                                <span class="status-badge status-active">Выполнена</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if reservation.status == 'pending' %}
                            <div style="display: flex; gap: 5px;">
                                <form action="{{ url_for('admin_fulfill_reservation', reservation_id=reservation.id) }}" method="POST" style="display: inline;">
                                    <button type="submit" class="btn btn-success" style="padding: 5px 10px;">
                                        <i class="fas fa-check"></i>
                                    </button>
                                </form>
                                <form action="{{ url_for('admin_cancel_reservation', reservation_id=reservation.id) }}" method="POST" style="display: inline;">
                                    <button type="submit" class="btn btn-danger" style="padding: 5px 10px;">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </form>
                            </div>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}